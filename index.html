<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#ffffff"/> <!-- Updated theme color for browser chrome -->
  <title>Smart Emotion Tracker</title>
  
  <!-- PWA Manifest --><link rel="manifest" href="manifest.json" />
  
  <!-- Fonts: Montserrat, Poppins, Roboto Condensed --><link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@600&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
  
  <!-- Chart.js --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase Imports (Module) --><script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Firebase/App Setup ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;
    window.moodEntries = []; // Make global for easy chart/log access

    // --- LLM API Configuration ---
    const GEMINI_API_URL_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
    const apiKey = ""; // Canvas will provide this if it's empty

    // --- External Resources Links (Mandatory) ---
    window.links = {
        habit: 'https://cognitioplus.aiwaapp.live/habit-design-studio',
        wellbe: 'https://cognitioplus.aiwaapp.live/well-be',
        resilience: 'https://cognitioplus.aiwaapp.live/resilience-navigator',
        counseling: 'https://cognitioplus.aiwaapp.live/online-counseling',
        growth: 'https://growth.cognitio-plus.com'
    };


    // --- Data Configuration (Re-added) ---
    const emotionMap = {
      red: ['Angry', 'Frustrated', 'Anxious', 'Irritated', 'Stressed', 'Worried', 'Fearful'],
      yellow: ['Excited', 'Happy', 'Focused', 'Wowed', 'Determined', 'Joyful', 'Optimistic'],
      blue: ['Tired', 'Sad', 'Bored', 'Lonely', 'Disappointed', 'Grieving', 'Hopeless'],
      green: ['Calm', 'Relaxed', 'Content', 'Thankful', 'Peaceful', 'Curious', 'Mellow']
    };
    
    // --- DOM Elements (Deferred assignment) ---
    let quadrantSelect;
    let emotionSelect;
    let form;
    let logList;
    let ctx;
    let moodChart;
    let reminderTimeInput;


    // --- CUSTOM MODAL/ALERT FUNCTIONS (Replaces browser alert/confirm) ---

    // Get modal DOM elements (These are defined in the body later, but accessed here)
    let customModal;
    let modalMessage;
    let modalConfirmBtn;
    let modalCancelBtn;
    
    function initModalElements() {
        customModal = document.getElementById('customModal');
        modalMessage = document.getElementById('modalMessage');
        modalConfirmBtn = document.getElementById('modalConfirm');
        modalCancelBtn = document.getElementById('modalCancel');
    }

    function showCustomAlert(message) {
        if (!customModal) initModalElements();
        modalMessage.innerHTML = `<p>${message}</p>`;
        modalConfirmBtn.textContent = 'OK';
        modalCancelBtn.style.display = 'none';
        
        const closeModal = () => {
            customModal.style.display = 'none';
            modalConfirmBtn.removeEventListener('click', closeModal);
        };
        
        modalConfirmBtn.addEventListener('click', closeModal);
        customModal.style.display = 'flex';
    }

    function showCustomConfirm(message, onConfirm) {
        if (!customModal) initModalElements();
        modalMessage.innerHTML = `<p>${message}</p>`;
        modalConfirmBtn.textContent = 'Yes, Delete';
        modalCancelBtn.style.display = 'inline-block';
        
        const cleanup = () => {
            customModal.style.display = 'none';
            modalConfirmBtn.removeEventListener('click', handleConfirm);
            modalCancelBtn.removeEventListener('click', handleCancel);
        };

        const handleConfirm = () => {
            onConfirm();
            cleanup();
        };

        const handleCancel = () => {
            cleanup();
        };

        modalConfirmBtn.addEventListener('click', handleConfirm);
        modalCancelBtn.addEventListener('click', handleCancel);
        customModal.style.display = 'flex';
    }


    // --- LLM API CALL WITH BACKOFF ---

    async function geminiApiCall(payload, maxRetries = 5) {
        const apiUrl = `${GEMINI_API_URL_BASE}?key=${apiKey}`;
        
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return await response.json();
                } else if (response.status === 429 && attempt < maxRetries - 1) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue; // Retry
                } else {
                    throw new Error(`API error: ${response.statusText}`);
                }
            } catch (error) {
                if (attempt === maxRetries - 1) throw error;
            }
        }
        throw new Error("API call failed after maximum retries.");
    }

    // --- GENERATE INSIGHTS FUNCTION ---
    async function generateInsights() {
        const outputDiv = document.getElementById('insightsOutput');
        const generateBtn = document.getElementById('generateInsightsBtn');
        const entries = window.moodEntries;

        if (entries.length < 5) {
            outputDiv.innerHTML = '<p style="color:var(--red-text); text-align:center;">Please log at least 5 entries to generate meaningful insights.</p>';
            return;
        }

        // Show loading state
        outputDiv.innerHTML = '<div class="loading-spinner"></div><p style="text-align:center; color: var(--brand-primary); font-style:italic;">Analyzing data and generating personalized insights...</p>';
        generateBtn.disabled = true;

        // 1. Prepare data for the LLM (Summarize the last 30 logs)
        const recentEntries = entries.slice(0, 30);
        const dataSummary = recentEntries.map(e => 
            `[${new Date(e.timestamp).toLocaleDateString()}] ${e.emotion} (${e.intensity}/10) in ${e.quadrant} zone. Activity: ${e.tag}. Trigger: ${e.trigger}.`
        ).join('\n');

        // --- UPDATED SYSTEM PROMPT to incorporate Hawkins' Model ---
        const systemPrompt = `You are a compassionate and professional AI Mental Wellness Coach. You use the principles of the Hawkins Map of Consciousness (emotional calibration, hidden needs, and resilient shifts) to guide the user. Your task is to analyze the user's mood logs and provide a three-part response:

1. **Analysis & Hidden Need:** Summarize key patterns, identifying the most frequent Low Valence emotion (e.g., Grief, Fear, Shame, Desire, Pride) and stating its **Hidden Need** based on the Map of Consciousness (e.g., Shame is love's cry for acceptance, Grief longs for comfort/healing).
2. **Resilient Shift (Actionable Recommendations):** Provide 2-3 specific, actionable recommendations framed as a **Resilient Shift** towards a higher frequency state (e.g., moving Grief toward Compassionate Meaning-Making). Focus on simple, mindful actions.
3. **External Resources:** Recommend specific external resources based on the user's needs. Use markdown links for the following resources EXACTLY as provided, without adding extra text around the links themselves:
   - For mood regulation or skill building: Habit Design Studio (${window.links.habit}) or Resilience Navigator (${window.links.resilience}).
   - For physical/mindfulness health: Well-Be (${window.links.wellbe}).
   - If the analysis suggests frequent, high-intensity Low Valence moods or signs of burnout (especially chronic Red/Blue zone entries): recommend accessing online counseling (${window.links.counseling}) or joining GROWTH Tribe (${window.links.growth}).
   
Format your entire response using Markdown in this structure:

### Summary Analysis & Hidden Need
[Your analysis, explicitly mentioning the most frequent low-frequency emotion and its hidden need.]

### Resilient Shifts for Growth
[Recommendation 1: Focused on addressing the hidden need.]
[Recommendation 2: Focused on a mindful action/skill.]

### Next Steps & Resources
[Relevant resource link 1]
[Relevant resource link 2]
[Relevant resource link 3 - if applicable based on severity]
`;

        const userQuery = `Analyze the following mood log data and provide insights and resources based on the Map of Consciousness. The data is structured as: [Date] [Emotion] (Intensity/10) in [Quadrant] zone. Activity: [Tag]. Trigger: [Trigger].\n\n--- DATA ---\n${dataSummary}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            // Using search grounding to ensure the recommendations are based on best practices
            tools: [{ "google_search": {} }] 
        };
        
        try {
            const result = await geminiApiCall(payload);
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate insights at this time. The API returned an empty response.";
            
            // Format the result for display (Gemini returns raw Markdown)
            outputDiv.innerHTML = `<div class="ai-result-box markdown-body">${text}</div>`;
            
        } catch (error) {
            console.error("Gemini API call failed:", error);
            showCustomAlert("Error generating insights. Please check the console for details or try again later.");
            outputDiv.innerHTML = '<p style="color:var(--red-text); text-align:center;">Error generating insights. Please try again later.</p>';
        } finally {
            generateBtn.disabled = false;
        }
    }


    // --- FIREBASE FUNCTIONS ---

    async function initializeFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing.");
            isAuthReady = true;
            loadLogs([]);
            updateChart([]);
            return;
        }

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');

            // 1. Initial Authentication Flow
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    const userIdDisplay = document.getElementById('userIdDisplay');
                    if (userIdDisplay) userIdDisplay.textContent = userId;
                    subscribeToLogs(); // Start listening for data
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch(e) {
                        console.error("Initial sign-in failed:", e);
                        isAuthReady = true;
                        loadLogs([]);
                        updateChart([]);
                    }
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
    }

    // 2. Real-time Data Subscription
    function subscribeToLogs() {
        if (!isAuthReady || !userId || !db) return;

        const path = `artifacts/${appId}/users/${userId}/moodEntries`;
        const q = query(collection(db, path));
        
        onSnapshot(q, (snapshot) => {
            window.moodEntries = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    timestamp: data.timestamp && typeof data.timestamp.toDate === 'function' 
                               ? data.timestamp.toDate().toISOString() 
                               : new Date().toISOString()
                };
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            console.log(`Fetched ${window.moodEntries.length} mood entries.`);
            loadLogs(window.moodEntries);
            updateChart(window.moodEntries);
        }, (error) => {
            console.error("Error subscribing to Firestore:", error);
            showCustomAlert(`Error connecting to mood data: ${error.message}`);
        });
    }

    // 3. Save Entry Function (Add Document)
    async function saveEntry(entry) {
        if (!isAuthReady || !userId || !db) {
             console.error("Cannot save: Authentication or initialization not complete.");
             showCustomAlert("Cannot save entry. Authentication is not complete.");
             return;
        }
        try {
            const path = `artifacts/${appId}/users/${userId}/moodEntries`;
            await addDoc(collection(db, path), {
                ...entry,
                timestamp: new Date()
            });
            console.log("Entry saved to Firestore.");
        } catch (error) {
            console.error("Error adding document: ", error);
            showCustomAlert("Error saving entry. Check console for details.");
        }
    }

    // 4. Delete Entry Function (Delete Document)
    async function deleteEntry(docId) {
        const performDelete = async () => {
            if (!isAuthReady || !userId || !db) {
                console.error("Cannot delete: Authentication or initialization not complete.");
                showCustomAlert("Cannot delete entry. Authentication is not complete.");
                return;
            }
            try {
                const path = `artifacts/${appId}/users/${userId}/moodEntries`;
                const docRef = doc(db, path, docId);
                await deleteDoc(docRef);
                console.log("Entry deleted from Firestore.");
            } catch (error) {
                console.error("Error deleting document: ", error);
                showCustomAlert("Error deleting entry. Check console for details.");
            }
        };

        showCustomConfirm('Are you sure you want to permanently delete this mood entry?', performDelete);
    }

    // --- NOTIFICATION & REMINDER FUNCTIONS ---

    // 1. Request Notification Permission
    function requestNotificationPermission() {
        if (!('Notification' in window)) {
            console.warn("Notifications not supported in this browser.");
            return;
        }
        if (Notification.permission === 'granted') {
            return; // Already granted
        }
        
        // Politely request permission
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showCustomAlert("Notification permission granted! You can now set a daily reminder.");
            } else {
                console.warn("Notification permission denied.");
            }
        });
    }
    
    // 2. Schedule Daily Reminder
    async function scheduleDailyReminder(time) {
        if (Notification.permission !== 'granted') {
            showCustomAlert("Please grant notification permission first to set a reminder.");
            return;
        }

        if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {
            showCustomAlert("Service Worker not active. Cannot schedule reminder.");
            return;
        }

        try {
            // Store the chosen time in localStorage
            localStorage.setItem('dailyReminderTime', time);
            
            // Attempt to register a Periodic Background Sync
            const registration = await navigator.serviceWorker.ready;
            
            // Send a message to the service worker to update its internal schedule/state
            navigator.serviceWorker.controller.postMessage({
                type: 'SET_REMINDER',
                time: time
            });

            // Note: Periodic Background Sync is unreliable for exact daily timing.
            // We use a simplified message/localStorage approach for demonstration.

            showCustomAlert(`Daily reminder set for ${time}! The Service Worker will attempt to notify you around that time.`);

        } catch (error) {
            console.error("Error scheduling reminder:", error);
            showCustomAlert("Could not set reminder. See console for details.");
        }
    }
    
    // 3. Load Saved Reminder Time
    function loadReminderTime() {
        const savedTime = localStorage.getItem('dailyReminderTime');
        if (reminderTimeInput && savedTime) {
            reminderTimeInput.value = savedTime;
        }
    }


    // --- UI/LOCAL FUNCTIONS ---
    
    function formatDate(isoString) {
      const date = new Date(isoString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function loadLogs(entries) {
      if (!logList) return; // Guard clause for logs
      
      logList.innerHTML = '';

      if (entries.length === 0) {
        logList.innerHTML = '<p style="text-align:center; color:#888;">No logs yet. Start tracking! (Data is now synced via Firestore)</p>';
        return;
      }

      entries.forEach(entry => {
        const div = document.createElement('div');
        const entryId = entry.id; 
        div.className = `log-item ${entry.quadrant}`;
        div.innerHTML = `
          <div class="log-content">
            <h4>${entry.emotion} <small>(${entry.intensity}/10)</small></h4>
            <div class="log-meta">
              <span>üìÖ ${formatDate(entry.timestamp)}</span> | 
              <span>üè∑Ô∏è ${entry.tag}</span>
            </div>
            ${entry.trigger && entry.trigger !== 'N/A' ? `<div class="log-meta">‚ö° Trigger: ${entry.trigger}</div>` : ''}
            ${entry.note ? `<p class="log-note">"${entry.note}"</p>` : ''}
          </div>
          <button class="delete-btn" onclick="window.deleteEntryWrapper('${entryId}')">&times;</button>
        `;
        logList.appendChild(div);
      });
    }

    function updateChart(entries) {
      // Robust check for ctx, which is assigned in DOMContentLoaded
      if (!ctx) {
          console.error("Chart context (ctx) is not yet available.");
          return;
      }

      const days = [];
      for(let i=6; i>=0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        days.push(d.toLocaleDateString());
      }

      const data = {
        red: new Array(7).fill(0),
        yellow: new Array(7).fill(0),
        blue: new Array(7).fill(0),
        green: new Array(7).fill(0)
      };

      entries.forEach(e => {
        const eDate = new Date(e.timestamp).toLocaleDateString();
        const index = days.indexOf(eDate);
        if (index !== -1) {
          data[e.quadrant][index]++;
        }
      });

      if (moodChart) moodChart.destroy();

      moodChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: days,
          datasets: [
            // UPDATED LABEL TEXT to reflect Valence terms
            { label: 'Red (High Energy/Low Valence)', data: data.red, backgroundColor: '#ef5350' },
            { label: 'Yellow (High Energy/High Valence)', data: data.yellow, backgroundColor: '#fdd835' },
            { label: 'Blue (Low Energy/Low Valence)', data: data.blue, backgroundColor: '#42a5f5' },
            { label: 'Green (Low Energy/High Valence)', data: data.green, backgroundColor: '#66bb6a' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } }
          },
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }


    // --- Event Listeners and Initializers ---

    document.addEventListener('DOMContentLoaded', () => {
        // Assign DOM elements now that the DOM is ready
        quadrantSelect = document.getElementById('quadrant');
        emotionSelect = document.getElementById('emotion');
        form = document.getElementById('moodForm');
        logList = document.getElementById('logList');
        reminderTimeInput = document.getElementById('reminderTime');
        
        const canvas = document.getElementById('moodChart');
        if (canvas) {
            // This is the assignment that needs to happen AFTER the canvas element exists
            ctx = canvas.getContext('2d');
        } else {
            console.error("Chart canvas not found. Charting functionality disabled.");
        }
        
        initModalElements(); // Initialize modal elements

        // Quadrant Change Listener
        if (quadrantSelect) {
            quadrantSelect.addEventListener('change', (e) => {
                const selectedQuad = e.target.value;
                emotionSelect.innerHTML = '<option value="">-- Select Emotion --</option>';
                
                if (selectedQuad && emotionMap[selectedQuad]) {
                    emotionSelect.disabled = false;
                    const sortedEmotions = [...emotionMap[selectedQuad]].sort();
                    
                    sortedEmotions.forEach(emo => {
                        const opt = document.createElement('option');
                        opt.value = emo;
                        opt.textContent = emo;
                        emotionSelect.appendChild(opt);
                    });
                } else {
                    emotionSelect.disabled = true;
                }
            });
        }

        // Form Submit Listener
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const entry = {
                    quadrant: quadrantSelect.value,
                    emotion: emotionSelect.value,
                    intensity: document.getElementById('intensity').value,
                    tag: document.getElementById('tag').value,
                    trigger: document.getElementById('trigger').value || 'N/A',
                    note: document.getElementById('note').value || ''
                };

                await saveEntry(entry);
                
                form.reset();
                // Safely update output element
                const outputElement = document.querySelector('#intensity-output');
                if (outputElement) {
                   outputElement.textContent = "5";
                }
                emotionSelect.disabled = true;
                emotionSelect.innerHTML = '<option value="">-- Select Quadrant First --</option>';
            });
        }
        
        // Attach AI listener
        const generateBtn = document.getElementById('generateInsightsBtn');
        if (generateBtn) {
            generateBtn.addEventListener('click', generateInsights);
        }
        
        // Attach Reminder listener
        const reminderForm = document.getElementById('reminderForm');
        if (reminderForm) {
            reminderForm.addEventListener('submit', (e) => {
                e.preventDefault();
                scheduleDailyReminder(reminderTimeInput.value);
            });
        }

        // Expose delete wrapper
        window.deleteEntryWrapper = deleteEntry;
        
        // Load saved reminder time
        loadReminderTime();

        // NEW FIX: Initialize Firebase ONLY after all DOM elements are guaranteed to be available
        initializeFirebase();
        
        // Request Notification Permission on load
        requestNotificationPermission();
    });


    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('SW Registered'))
          .catch(err => console.log('SW Fail', err));
      });
    }

  </script>

  <style>
    :root {
      /* Brand Colors */
      --brand-primary: #b425aa;
      --brand-secondary: #c80ec9;
      --brand-gold: #D4AF37;
      
      /* Quadrant Colors */
      --red-bg: #ffebee; --red-text: #c62828; --red-border: #ef5350;
      --yellow-bg: #fffde7; --yellow-text: #f9a825; --yellow-border: #fdd835;
      --blue-bg: #e3f2fd; --blue-text: #1565c0; --blue-border: #42a5f5;
      --green-bg: #e8f5e9; --green-text: #2e7d32; --green-border: #66bb6a;
      
      --dark: #333; --light: #fdfbfd; --white: #fff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Roboto Condensed', sans-serif;
      background-color: var(--light);
      color: var(--dark);
      padding-bottom: 80px;
    }

    /* Brand Header */
    header {
      background: var(--white); 
      color: var(--dark); 
      padding: 1.5rem 1rem;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); 
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 3px solid var(--brand-primary); 
    }

    .brand-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 0.5rem;
    }

    .brand-logo {
      width: 45px;
      height: 45px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    header h1 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0;
      color: var(--brand-primary); 
    }

    header p {
      color: #666; 
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }
    
    .user-info {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        color: #999; 
    }
    
    .valence-note {
        font-size: 0.8rem;
        color: var(--brand-secondary);
        font-style: italic;
        margin-top: 0.5rem;
    }

    main {
      max-width: 800px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* Sections */
    section {
      background: var(--white);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border-top: 4px solid var(--brand-primary);
    }

    h2 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--brand-primary);
      border-bottom: 2px solid #eee;
      padding-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Small form for reminder */
    #reminderForm {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    #reminderForm input[type="time"] {
        flex-grow: 1;
        max-width: 150px;
        padding: 12px;
        border-radius: 10px;
    }
    
    #reminderForm button {
        padding: 12px 20px;
        margin-top: 0;
        width: auto;
    }


    /* Mood Image */
    .mood-image-container {
      text-align: center;
      margin-bottom: 1.5rem;
      height: 300px; 
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden; 
    }
    
    .mood-image {
      width: 100%;
      height: 100%; 
      object-fit: contain; 
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      border: 2px solid var(--brand-gold);
    }

    /* Quadrants Info */
    .quadrants {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .quadrant {
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      font-size: 1rem;
      transition: transform 0.2s;
    }
    
    .quadrant:hover { transform: translateY(-2px); }

    .red { background: var(--red-bg); color: var(--red-text); border: 1px solid var(--red-border); }
    .yellow { background: var(--yellow-bg); color: var(--yellow-text); border: 1px solid var(--yellow-border); }
    .blue { background: var(--blue-bg); color: var(--blue-text); border: 1px solid var(--blue-border); }
    .green { background: var(--green-bg); color: var(--green-text); border: 1px solid var(--green-border); }

    /* Form */
    form:not(#reminderForm) { display: grid; gap: 1.2rem; }
    
    /* Tooltip Styles */
    .tooltip-container {
        position: relative;
        display: block; /* Make the whole group a block element */
    }

    .tooltip-trigger {
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--brand-primary);
        margin-bottom: 0.4rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-icon {
        cursor: pointer;
        color: var(--brand-secondary);
        font-size: 1.1rem;
        line-height: 1;
        transition: transform 0.2s;
        font-family: Arial, sans-serif; /* Ensure the question mark renders cleanly */
        font-style: normal;
        user-select: none;
    }
    
    .info-icon:hover {
        transform: scale(1.1);
    }

    .tooltip-content {
        visibility: hidden;
        background-color: var(--dark);
        color: var(--white);
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 100%; /* Position above the trigger */
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
        width: 250px;
        font-size: 0.85rem;
        font-family: 'Roboto Condensed', sans-serif;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .tooltip-content::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: var(--dark) transparent transparent transparent;
    }

    /* Show tooltip on hover or focus of the label/input container */
    .tooltip-container:hover .tooltip-content,
    .tooltip-container:focus-within .tooltip-content {
        visibility: visible;
        opacity: 1;
        bottom: 110%; /* Move up slightly on hover */
    }
    /* End Tooltip Styles */


    select, input:not([type="range"]), textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #eee;
      border-radius: 10px;
      font-size: 1rem;
      font-family: 'Roboto Condensed', sans-serif;
      background: #fafafa;
      transition: border-color 0.3s;
    }
    
    input[type="time"] {
        padding: 12px;
    }


    select:focus, input:not([type="range"]):focus, textarea:focus {
      outline: none;
      border-color: var(--brand-secondary);
      background: #fff;
    }

    button[type="submit"]:not(#reminderForm button), #generateInsightsBtn {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, var(--brand-primary), var(--brand-secondary));
      color: white;
      border: none;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: opacity 0.3s, transform 0.1s;
      box-shadow: 0 4px 10px rgba(180, 37, 170, 0.4);
      margin-top: 1rem;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button:active {
      transform: translateY(1px);
    }
    
    .input-group {
        display: flex;
        flex-direction: column;
    }
    
    .intensity-control {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .intensity-control input[type="range"] {
        flex-grow: 1;
        -webkit-appearance: none;
        appearance: none;
        height: 10px;
        background: #ddd;
        border-radius: 5px;
        cursor: pointer;
        outline: none;
    }

    .intensity-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--brand-primary);
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    .intensity-control output {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--brand-secondary);
        width: 30px;
        text-align: right;
    }
    
    /* Log History Styling */
    .log-item {
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: box-shadow 0.3s;
    }
    
    .log-item:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .log-item h4 {
        margin: 0 0 5px 0;
        font-family: 'Poppins', sans-serif;
        font-size: 1.2rem;
    }
    
    .log-item small {
        font-size: 0.8rem;
        opacity: 0.7;
    }

    .log-meta {
        font-size: 0.85rem;
        color: #666;
        margin-top: 3px;
    }
    
    .log-note {
        margin-top: 10px;
        padding-left: 10px;
        border-left: 3px solid var(--brand-primary);
        font-style: italic;
        color: #555;
        font-size: 0.9rem;
    }
    
    .delete-btn {
        background: none;
        border: none;
        color: var(--red-text);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        transition: transform 0.2s;
        margin-left: 10px;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .delete-btn:hover {
        transform: scale(1.1);
        color: #ff0000;
    }
    
    /* Chart Container for responsiveness */
    .chart-container {
        position: relative;
        height: 300px; /* Fixed height for chart visibility */
        width: 100%;
    }
    
    /* AI Insights Styling */
    .ai-result-box {
        background: #f7f3f9;
        border: 1px solid var(--brand-primary);
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid var(--brand-primary);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 1rem auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Custom Modal Styles */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 200; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.4); 
        justify-content: center;
        align-items: center;
        padding: 1rem;
    }

    .modal-content {
        background-color: var(--white);
        margin: auto;
        padding: 20px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        text-align: center;
        animation: modalopen 0.3s;
    }
    
    @keyframes modalopen {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }

    #modalMessage p {
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        color: var(--dark);
    }

    .modal-actions button {
        margin: 0 10px;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
        box-shadow: none;
        margin-top: 0;
    }

    #modalConfirm {
        background-color: var(--red-text);
        color: white;
    }
    
    #modalConfirm[data-type="alert"] {
        background: linear-gradient(to right, var(--brand-primary), var(--brand-secondary));
    }

    #modalCancel {
        background-color: #ccc;
        color: var(--dark);
    }
    
    @media (max-width: 600px) {
        main {
            padding: 1rem;
        }
        
        section {
            padding: 1rem;
        }
        
        .quadrants {
            grid-template-columns: 1fr;
        }
        
        .mood-image-container {
            height: 250px;
        }
        
        header h1 {
            font-size: 1.5rem;
        }
        
        /* Adjust tooltip on small screens */
        .tooltip-content {
            left: 0;
            transform: translateX(0);
            bottom: unset;
            top: 100%;
            margin-top: 5px;
            width: 95%; /* Use full width */
        }
        
        .tooltip-content::after {
            top: -5px;
            left: 25px; /* Adjust arrow position */
            border-color: transparent transparent var(--dark) transparent;
        }
        
        .tooltip-container:hover .tooltip-content,
        .tooltip-container:focus-within .tooltip-content {
            top: 105%;
            bottom: unset;
        }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand-container">
      <img src="https://appimize.app/assets/apps/user_1097/images/af5331a08cd5_576_1097.png" alt="Smart Emotion Tracker Logo" class="brand-logo">
      <h1>Smart Emotion Tracker</h1>
    </div>
    <p>Your Smart Companion for Emotional Wellness</p>
    <div class="user-info">
      User ID: <span id="userIdDisplay">Loading...</span>
    </div>
    <p class="valence-note">
        Terminology Note: Since all emotions are valuable signals, we use the scientific term "Valence" (how pleasant or unpleasant an emotion feels) instead of 'positive' or 'negative'.
    </p>
  </header>

  <main>
    <!-- 1. Mood Entry Form -->
    <section>
      <h2>‚úçÔ∏è Log Your Mood</h2>
      <form id="moodForm">
        <div class="input-group">
          <div class="tooltip-container">
            <label for="quadrant" class="tooltip-trigger">
              1. Choose Quadrant 
              <span class="info-icon">?</span>
              <div class="tooltip-content">
                The Energy/Valence Map: Select the zone that best describes your feeling based on its Energy (High/Low Arousal) and Valence (High/Low Pleasantness).
              </div>
            </label>
          </div>
          <select id="quadrant" required>
            <option value="">-- Select Quadrant --</option>
            <!-- UPDATED TEXT: Unpleasant -> Low Valence, Pleasant -> High Valence -->
            <option value="red">Red (High Energy, Low Valence)</option>
            <option value="yellow">Yellow (High Energy, High Valence)</option>
            <option value="blue">Blue (Low Energy, Low Valence)</option>
            <option value="green">Green (Low Energy, High Valence)</option>
          </select>
        </div>
        
        <div class="input-group">
          <div class="tooltip-container">
            <label for="emotion" class="tooltip-trigger">
              2. Select Specific Emotion 
              <span class="info-icon">?</span>
              <div class="tooltip-content">
                From the list of emotions specific to your chosen quadrant, select the one that most accurately reflects your internal state right now.
              </div>
            </label>
          </div>
          <select id="emotion" disabled required>
            <option value="">-- Select Quadrant First --</option>
          </select>
        </div>

        <div class="input-group">
          <div class="tooltip-container">
            <label for="intensity" class="tooltip-trigger">
              3. Intensity Level (1-10) 
              <span class="info-icon">?</span>
              <div class="tooltip-content">
                Rate the strength of this emotion from 1 (Very Mild/Slight) to 10 (Overwhelming/Max Strength).
              </div>
            </label>
          </div>
          <div class="intensity-control">
            <input type="range" id="intensity" min="1" max="10" value="5" oninput="document.querySelector('#intensity-output').textContent=this.value">
            <output id="intensity-output">5</output>
          </div>
        </div>
        
        <div class="input-group">
          <div class="tooltip-container">
            <label for="tag" class="tooltip-trigger">
              4. Activity/Context Tag 
              <span class="info-icon">?</span>
              <div class="tooltip-content">
                Categorize the main activity or setting where this emotion occurred. This helps identify where you are most frequently feeling certain emotions.
              </div>
            </label>
          </div>
          <select id="tag" required>
            <option value="Work">Work</option>
            <option value="Family">Family/Relationship</option>
            <option value="Health">Health/Exercise</option>
            <option value="Leisure">Leisure/Hobby</option>
            <option value="Sleep">Sleep/Rest</option>
            <option value="Commute">Commute/Travel</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="input-group">
          <div class="tooltip-container">
            <label for="trigger" class="tooltip-trigger">
              5. What was the Trigger? (Optional) 
              <span class="info-icon">?</span>
              <div class="tooltip-content">
                What specific event, thought, or interaction immediately preceded this mood? Be brief and specific (e.g., 'Deadline approaching', 'Argument with partner').
              </div>
            </label>
          </div>
          <input type="text" id="trigger" placeholder="Briefly describe what happened">
        </div>

        <div class="input-group">
          <div class="tooltip-container">
            <label for="note" class="tooltip-trigger">
              6. Quick Note (Optional) 
              <span class="info-icon">?</span>
              <div class="tooltip-content">
                A space for journaling or elaborating on your thoughts. The AI uses this for deeper analysis.
              </div>
            </label>
          </div>
          <textarea id="note" rows="2" placeholder="Any further details or thoughts..."></textarea>
        </div>

        <button type="submit">Log My Mood</button>
      </form>
    </section>

    <!-- 2. Mood Quadrant Chart (with user image) -->
    <section>
      <h2> Emotion Quadrants: The Energy - Valence Map</h2>
      <div class="mood-image-container">
        <!-- Replaced placeholder with user's uploaded image path -->
        <img src="https://cognitioplus.aiwaapp.live/cache/media_cache/390557ed1a7dccd01221f77ad5095327.png" alt="Mood Quadrant Chart" class="mood-image">
      </div>
      <div class="quadrants">
        <!-- UPDATED TEXT: Unpleasant -> Low Valence, Pleasant -> High Valence -->
        <div class="quadrant red"><h3>Red Zone</h3><p>High Energy, Low Valence (e.g., Anger, Anxiety)</p></div>
        <div class="quadrant yellow"><h3>Yellow Zone</h3><p>High Energy, High Valence (e.g., Excitement, Focus)</p></div>
        <div class="quadrant blue"><h3>Blue Zone</h3><p>Low Energy, Low Valence (e.g., Sadness, Boredom)</p></div>
        <div class="quadrant green"><h3>Green Zone</h3><p>Low Energy, High Valence (e.g., Calm, Content)</p></div>
      </div>
    </section>

    <!-- 3. AI Insights -->
    <section>
      <h2>üí° Personalized Insights</h2>
      <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #555;">Generate your analysis based on the Hawkins Map of Consciousness. Requires at least 5 logged entries.</p>
      <button id="generateInsightsBtn">Generate Insights & Recommendations</button>
      <div id="insightsOutput" style="margin-top: 1rem;">
        <p style="text-align:center; color:#888;">AI insights will appear here after logging a few entries.</p>
      </div>
    </section>
    
    <!-- 4. Mood Data Chart (Chart.js) -->
    <section>
      <h2>üìä Weekly Mood Overview</h2>
      <div class="chart-container">
        <canvas id="moodChart"></canvas>
      </div>
    </section>

    <!-- 5. Mood Log History -->
    <section>
      <h2>üìú Mood Log History</h2>
      <div id="logList">
        <!-- Logs populated by JS -->
        <p style="text-align:center; color:#888;">Loading logs...</p>
      </div>
    </section>

    <!-- 6. Daily Reminder -->
    <section>
        <h2>üîî Daily Reminder</h2>
        <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #555;">Set a specific time to receive a notification reminding you to log your mood.</p>
        <form id="reminderForm">
            <input type="time" id="reminderTime" required value="19:00">
            <button type="submit">Set Reminder</button>
        </form>
    </section>
  </main>
  
  <!-- Custom Modal for Alerts/Confirms (Hidden by default) -->
  <div id="customModal" class="modal">
    <div class="modal-content">
      <div id="modalMessage"></div>
      <div class="modal-actions">
        <button id="modalCancel">Cancel</button>
        <button id="modalConfirm">OK</button>
      </div>
    </div>
  </div>
</body>
</html>
